name: Build (CI downloads Dalamud DLLs)

on:
  push:
    tags:   [ 'v*' ]
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # Provide a secret DALAMUD_HOOKS_URL that points to your hooks_dev.zip
      - name: Download Dalamud/Lumina pack
        shell: pwsh
        run: |
          $hooks = "$env:RUNNER_TEMP\hooks_dev"
          New-Item -ItemType Directory -Force -Path $hooks | Out-Null
          $zip = "$env:RUNNER_TEMP\hooks_dev.zip"
          Invoke-WebRequest -Uri "${{ secrets.DALAMUD_HOOKS_URL }}" -OutFile $zip
          Expand-Archive $zip -DestinationPath $hooks -Force
          "HOOKS=$hooks" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Determine version from tag (Option 3 behavior)
        id: version
        shell: pwsh
        run: |
          $ref = "${{ github.ref }}"
          if ($ref -match '^refs/tags/v(\d+\.\d+\.\d+.*)$') { $v = $matches[1] }
          else { $v = "0.0.1-ci-$("${{ github.sha }}".Substring(0,7))" }
          "VERSION=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Build
        shell: pwsh
        run: |
          dotnet build .\SupplyMissionHelper.csproj `
            -c Release `
            /p:Version="${{ steps.version.outputs.VERSION }}" `
            /p:DalamudLibPath="$env:HOOKS\"

      - name: Stage + Zip
        shell: pwsh
        run: |
          $outDir = "bin\Release"
          $distRoot = "dist"
          $dist = Join-Path $distRoot "SupplyMissionHelper"
          $zip  = Join-Path $distRoot "SupplyMissionHelper-${{ steps.version.outputs.VERSION }}.zip"

          if (Test-Path $dist) { Remove-Item $dist -Recurse -Force }
          if (-not (Test-Path $distRoot)) { New-Item $distRoot -ItemType Directory | Out-Null }
          New-Item $dist -ItemType Directory | Out-Null

          Copy-Item "$outDir\SupplyMissionHelper.dll" $dist
          if (Test-Path "$outDir\SupplyMissionHelper.pdb") { Copy-Item "$outDir\SupplyMissionHelper.pdb" $dist }
          Copy-Item ".\manifest.json" $dist

          if (Test-Path $zip) { Remove-Item $zip -Force }
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::CreateFromDirectory($dist, $zip)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SupplyMissionHelper-${{ steps.version.outputs.VERSION }}
          path: dist/**
